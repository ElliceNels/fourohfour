<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Test - fourohfour Files</title>
    <script src="https://cdn.jsdelivr.net/npm/libsodium-wrappers@0.7.13/dist/libsodium.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .pass {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .fail {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      button {
        padding: 10px 20px;
        margin: 10px 0;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <h1>Libsodium-js Crypto Test</h1>
    <p>This page tests the cryptographic functions used in the web client.</p>

    <button onclick="runTests()">Run Tests</button>
    <div id="test-results"></div>

    <script>
      let sodiumReady = false;

      async function initSodium() {
        if (!sodiumReady) {
          await sodium.ready;
          sodiumReady = true;
        }
      }

      // Test functions from signup.js
      async function generateEd25519KeyPair() {
        await initSodium();
        const keypair = sodium.crypto_sign_keypair();
        return {
          publicKey: keypair.publicKey,
          privateKey: keypair.privateKey,
        };
      }

      async function deriveKeyFromPassword(password, salt) {
        await initSodium();
        const passwordBytes = sodium.from_string(password);

        const derivedKey = sodium.crypto_pwhash(
          sodium.crypto_aead_xchacha20poly1305_ietf_KEYBYTES,
          passwordBytes,
          salt,
          sodium.crypto_pwhash_OPSLIMIT_INTERACTIVE,
          sodium.crypto_pwhash_MEMLIMIT_INTERACTIVE,
          sodium.crypto_pwhash_ALG_ARGON2ID
        );

        return derivedKey;
      }

      async function encryptXChaCha20Poly1305(data, key) {
        await initSodium();
        const nonce = sodium.randombytes_buf(
          sodium.crypto_aead_xchacha20poly1305_ietf_NPUBBYTES
        );
        const dataBytes =
          typeof data === 'string' ? sodium.from_string(data) : data;

        const ciphertext = sodium.crypto_aead_xchacha20poly1305_ietf_encrypt(
          dataBytes,
          null,
          null,
          nonce,
          key
        );

        return { ciphertext, nonce };
      }

      async function decryptXChaCha20Poly1305(combinedData, key) {
        await initSodium();

        const nonceSize = sodium.crypto_aead_xchacha20poly1305_ietf_NPUBBYTES;
        const nonce = combinedData.slice(0, nonceSize);
        const ciphertext = combinedData.slice(nonceSize);

        const decrypted = sodium.crypto_aead_xchacha20poly1305_ietf_decrypt(
          null,
          ciphertext,
          null,
          nonce,
          key
        );

        return decrypted;
      }

      function combineNonceCiphertext(nonce, ciphertext) {
        const combined = new Uint8Array(nonce.length + ciphertext.length);
        combined.set(nonce, 0);
        combined.set(ciphertext, nonce.length);
        return combined;
      }

      function addTestResult(testName, passed, details) {
        const resultsDiv = document.getElementById('test-results');
        const resultDiv = document.createElement('div');
        resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
        resultDiv.innerHTML = `
                <strong>${testName}:</strong> ${passed ? 'PASS' : 'FAIL'}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
        resultsDiv.appendChild(resultDiv);
      }

      async function runTests() {
        const resultsDiv = document.getElementById('test-results');
        resultsDiv.innerHTML = '<p>Running tests...</p>';

        try {
          // Test 1: Sodium initialization
          await initSodium();
          addTestResult(
            'Sodium Initialization',
            true,
            'Libsodium-js loaded successfully'
          );

          // Test 2: Ed25519 key generation
          const keyPair = await generateEd25519KeyPair();
          const keyGenPass =
            keyPair.publicKey.length === 32 && keyPair.privateKey.length === 64;
          addTestResult(
            'Ed25519 Key Generation',
            keyGenPass,
            `Public key: ${keyPair.publicKey.length} bytes, Private key: ${keyPair.privateKey.length} bytes`
          );

          // Test 3: Password derivation
          const testPassword = 'testPassword123';
          const salt = sodium.randombytes_buf(16);
          const derivedKey = await deriveKeyFromPassword(testPassword, salt);
          const pwdDerivPass = derivedKey.length === 32;
          addTestResult(
            'Argon2id Password Derivation',
            pwdDerivPass,
            `Derived key length: ${derivedKey.length} bytes`
          );

          // Test 4: Encryption/Decryption round trip
          const testData = 'Hello, fourohfour Files!';
          const encrypted = await encryptXChaCha20Poly1305(
            testData,
            derivedKey
          );
          const combined = combineNonceCiphertext(
            encrypted.nonce,
            encrypted.ciphertext
          );
          const decrypted = await decryptXChaCha20Poly1305(
            combined,
            derivedKey
          );
          const decryptedText = sodium.to_string(decrypted);
          const roundTripPass = decryptedText === testData;
          addTestResult(
            'XChaCha20-Poly1305 Encryption/Decryption',
            roundTripPass,
            `Original: "${testData}", Decrypted: "${decryptedText}"`
          );

          // Test 5: Consistency with desktop client format
          const nonceSize = sodium.crypto_aead_xchacha20poly1305_ietf_NPUBBYTES;
          const formatPass =
            encrypted.nonce.length === nonceSize &&
            combined.length === nonceSize + encrypted.ciphertext.length;
          addTestResult(
            'Desktop Client Format Compatibility',
            formatPass,
            `Nonce size: ${encrypted.nonce.length}, Combined format: [${nonceSize} nonce][${encrypted.ciphertext.length} ciphertext]`
          );

          // Test 6: Key consistency
          const derivedKey2 = await deriveKeyFromPassword(testPassword, salt);
          const consistencyPass = sodium.compare(derivedKey, derivedKey2) === 0;
          addTestResult(
            'Password Derivation Consistency',
            consistencyPass,
            'Same password + salt produces same key'
          );

          addTestResult(
            'All Tests Complete',
            true,
            'Libsodium-js integration is working correctly!'
          );
        } catch (error) {
          addTestResult('Test Suite', false, `Error: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
